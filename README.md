# Ark-knight 项目实现功能与技术细节

该项目是基于《元气骑士》设计与实现的2D俯视角Roguelike游戏，旨在为玩家提供一个充满策略性的实时战斗体验。游戏通过BFS算法生成的随机地图，玩家需选择不同职业角色进行冒险，挑战各种敌人和Boss，并通过收集道具来强化自身。项目的核心系统包括角色管理、实时战斗、地图生成、道具收集等，确保游戏的多样性和策略深度。

项目中的关键技术包括基于Cocos2d-x的Node组件架构，状态机管理角色和敌人行为，BFS算法确保地图连通性，以及事件驱动的音效系统。特别是通过设计复杂的敌人AI和多阶段Boss战，使得战斗不仅仅局限于简单的攻击，而是能够与地形、道具产生深度交互，形成丰富的战斗策略。此外，使用现代C++特性提高了代码的简洁性与可维护性，确保系统的高效性与扩展性。

## 基础实现功能

### 角色与操作系统
- **三种职业角色**：妮芙(Nymph)远程魔法、维什戴尔(Wisdael)远程物理、泥岩(Mudrock)近战坦克
- **完整操作体系**：WASD移动、鼠标或者J攻击、右键或者K技能释放、E键交互、L键治疗
- **角色动画系统**：每个角色包含Idle、Move、Attack、Die、Skill等完整动画状态
- **属性管理**：血量、法力值、攻击力等核心数值系统

### 战斗系统
- **实时战斗**：流畅的实时战斗系统，支持攻击范围判定和伤害计算
- **多种差异化敌人AI**：阿咬(近战追击)、得意(远程射击)、新硎(魔法弹幕)、堂皇(重装坦克)、妒(敏捷刺客)、魂灵圣杯(召唤辅助)、铁矛头(精英近战)等共10余种敌人
- **复杂Boss机制**：奎隆Boss具备三阶段战斗、初始小怪召唤、动态场地火焰生成、血量阶段转换等复杂战斗机制
- **智能敌人行为**：每种敌人都有独特的移动速度随机化(90%-110%)、攻击模式、追击策略和配合机制
- **状态管理**：完整的角色状态机切换（Idle/攻击/受击/死亡）

### 地图系统
- **程序化生成**：基于BFS算法的随机地图生成，确保所有房间连通
- **多样化房间**：战斗房间、Boss房间、奖励房间、起始房间、终点房间
- **锁门机制**：击败房间内所有敌人才能开启房门
- **地形要素**：地刺陷阱、障碍物(Box/Pillar)、宝箱、传送门等交互元素

### 道具收集系统
- **三层道具体系**：低阶道具（6种）、高阶道具（5种）、国王收藏品（4种）形成完整的稀有度体系
- **低阶道具**：锈蚀刀片(Knife)增加攻击、急救药箱(First_Aid_Kit)增加血量、坚守盾牌(Shield)提供减伤、投币玩具(CoinToy)提升攻速、活玫瑰(Roses)强化治疗、快乐水(Happy_Juice)加速回蓝
- **高阶道具**：复仇者、未知仪器、古老的铠甲、迷梦香精、金酒之杯等强力装备，属性提升幅度更大
- **国王套装系统**：国王的新枪、诸王的冠冕、国王的铠甲、国王的延伸等4件套装，强力组合效果
- **概率掉落机制**：低阶60%、高阶30%、国王10%的合理掉落概率
- **属性叠加系统**：数值加成叠加，百分比加成乘算，实现复杂的数值计算

### UI与交互
- **游戏界面**：血条、法力条、小地图、技能冷却、道具栏等完整HUD
- **菜单系统**：主菜单、角色选择、游戏暂停、设置界面
- **交互提示**：动态显示可交互对象的按键提示
- **关卡场景切换与数据继承**：支持多关卡推进，玩家HP/MP/已收集道具在关卡间完整传承，通过静态变量实现场景间数据传递

### 音效系统
- **背景音乐**：主菜单、探索、战斗、Boss战等不同场景音乐
- **音效管理**：角色技能、敌人攻击、UI交互等丰富音效
- **动态切换**：根据游戏状态自动切换音乐

## 加分项

### 版本控制与协作
- **GitHub使用规范**：采用main-backup双分支安全合并策略，所有功能开发使用feature分支
- **合理分工**：模块化分工明确，Core/Entities/Map/UI等各系统责任到人
- **Commit记录清晰**：遵循"[Type(Scope)] Description"格式，包含Feat/Fix/Refactor等9种提交类型

### 代码质量
- **合理异常处理**：资源加载、对象创建等关键位置添加完善的错误处理和日志输出
- **无内存泄漏**：使用Cocos2d-x的引用计数内存管理，正确使用autorelease()和retain()/release()
- **代码规范**：统一使用Google C++ Style Guide，变量命名、函数设计、注释格式规范化

### C++特性
#### STL容器与迭代器
```cpp
std::vector<Enemy*> _enemies;  // 敌人容器管理
cocos2d::Vector<ItemDrop*> _itemDrops;  // Cocos容器
for (auto enemy : _enemies) {  // 范围for循环迭代
    if (enemy && !enemy->isDead()) {
        enemy->executeAI(_player, dt);
    }
}
```

#### 类与多态设计
```cpp
class Character : public GameEntity {  // 继承体系
public:
    virtual void update(float dt) = 0;  // 纯虚函数
    virtual void useSkill() = 0;
};
class Mage : public Player {  // 多层继承
    void useSkill() override;  // 多态实现
};
```

#### C++11/14特性使用
- **智能指针**：合理使用shared_ptr管理游戏对象生命周期
- **auto关键字**：简化复杂类型声明，提高代码可读性
- **lambda表达式**：回调函数和事件处理中使用lambda简化代码
- **std::shuffle**：替代已弃用的random_shuffle，使用现代随机库
- **nullptr**：替代传统NULL，类型安全的空指针表示

#### 异常处理
```cpp
if (!_sprite) {
    CCLOG("Failed to create sprite from %s", spritePath.c_str());
    return false;
}
```

#### 函数重载
```cpp
void addEnemy(Enemy* enemy);  // 基础版本
void addEnemy(Enemy* enemy, const Vec2& position);  // 重载版本
```

### 架构设计优雅
- **组件化设计**：采用Entity-Component架构，GameEntity基类，Character/Objects等专用组件
- **设计模式应用**：单例模式(SoundManager)、工厂模式(敌人创建)、状态机模式(角色行为)
- **模块解耦**：Map生成、战斗系统、UI管理、音效系统等各模块独立，通过接口交互
### 界面与体验
- **界面精美**：完整的UI系统，包含HUD、菜单、交互提示等精美界面设计
- **游戏不卡顿不崩溃**：经过充分测试，游戏运行稳定，无内存泄漏和崩溃问题
- **流畅动画**：角色动画、敌人AI行为、UI交互等都具备流畅的动画效果
- **音效体验**：完整的背景音乐和音效系统，根据游戏状态动态切换，提升沉浸感

### 核心技术算法
- **BFS地图生成算法**：使用广度优先搜索确保所有房间连通，智能分配房间类型保证游戏节奏
- **智能敌人AI**：基于状态机的敌人行为系统，支持巡逻→追击→攻击→死亡的完整状态转换
- **动态音效管理**：SoundManager单例模式统一管理，支持预加载、音量控制、场景音乐自动切换

## 项目结构

### 代码组织
```
Classes/
├── Core/              # 核心常量、宏定义
├── Entities/          # 游戏实体
│   ├── Base/          # GameEntity、Character基类
│   ├── Player/        # Mage、Gunner、Warrior角色
│   ├── Enemy/         # 8种敌人类型 + Boss
│   └── Objects/       # Item、Chest、Portal等对象
├── Map/               # BFS地图生成、房间系统
├── Scenes/            # 场景管理
├── UI/                # 用户界面
├── Managers/          # 音效等管理器
└── Utils/             # 工具函数
```

### 资源组织
```
Resources/
├── Player/            # 角色资源
│   ├── Nymph/         # 妮芙动画帧
│   ├── Wisdael/       # 维什戴尔动画帧
│   └── Mudrock/       # 泥岩动画帧
├── Enemy/             # 敌人资源
├── Map/               # 地图瓦片、传送门
├── Property/          # 道具图标资源
├── UIs/               # 界面图标
├── Music/             # 背景音乐
└── SoundEffect/       # 音效文件
```

## 开发环境

Windows 11操作系统，使用cocos2d-x-4.0引擎。

## 开发分工

| 成员 | 主要职责 | 具体实现 | 贡献度 |
|:----:|:--------:|:--------:|:------:|
| 熊庭楷 | 核心类中基本类、物件类、角色类的基本架构，地图类的架构，场景类，UI类，游戏管理器类等 | Player中Mage、Warrior、Gunner角色的基本架构、Objects中Chest、Portal、Item的实现，Map生成器、Room房间管理、Hallway走廊生成、Barriers障碍物、TerrainLayouts地形生成、Gamescene游戏场景 | 60% |
| 刘礼嘉 | 美术资源，核心类中敌人类，核心类中角色类的完善，地图类的完善，音频管理器类等 | Player中Mage、Warrior、Gunner角色特色的完善，Enemy中Ayao、Boat、Cup、DeYi等10余种敌人设计，KuiLongBoss的多阶段战斗，BossFloor特殊层，SoundManager音频管理器， | 40% |

通过合理的模块化分工和现代软件工程实践，项目实现了高质量的代码架构和丰富的游戏功能，为玩家提供了完整的Roguelike游戏体验。