### Classes 目录结构设计

```
Classes/
├── Core/               # ✅ 核心入口与全局定义
├── Scenes/             # ✅ 场景管理（高层逻辑）
├── Entities/           # ✅ 游戏实体（核心 OOP 继承体系）
│   ├── Base/           # ✅ 基类 (GameEntity, Character)
│   ├── Player/         # ✅ 玩家相关 (Player, Mage, Nymph, Wisdael, Mudrock)
│   ├── Enemy/          # ✅ 敌人与 AI (11种敌人 + 1个Boss)
│   └── Objects/        # ✅ 投射物、道具、武器
├── Map/                # ✅ 地图生成与管理
├── UI/                 # ✅ 用户界面与 HUD（已重构独立模块）
├── Managers/           # ⚪ 单例管理器（全局控制）
└── Utils/              # ⚪ 工具类与辅助函数
```

**图例：** ✅ 已实现 | 🔄 部分实现 | ⚪ 待实现

------



### 详细分类说明

#### 1. Core (核心层) ✅

存放程序的入口点和全局通用的定义。

- **✅ AppDelegate.h/cpp**: Cocos2d-x 程序的入口，负责初始化 GLContext，设置分辨率等。
- **✅ Constants.h**: 存放游戏常量（地图配置、房间尺寸、瓦片大小、方向定义、ZOrder等）。
  - 地图配置：`ROOM_TILES_W=26`, `ROOM_TILES_H=18`, `ROOM_CENTER_DIST=960`, `DOOR_WIDTH=4`
  - 方向定义：`DIR_UP/RIGHT/DOWN/LEFT`
  - ZOrder层级：`FLOOR`, `WALL_BELOW`, `WALL_ABOVE`, `PLAYER`, `ENEMY`
- **⚪ GameMacros.h**: (可选) 全局宏定义、Tag 枚举。

#### 2. Scenes (场景层) ✅

存放主要的游戏场景类，通常继承自 cocos2d::Scene。

- **⚪ MainMenuScene.h/cpp**: 开始菜单（开始游戏、设置、退出）。
- **✅ GameScene.h/cpp**: 核心战斗场景，负责承载地图层、游戏逻辑层和 UI 层。
  - 地图系统管理 (`MapGenerator`, `MiniMap`)
  - 玩家实例化与控制
  - 碰撞检测系统 (`updateMapSystem`)
  - 房间/走廊边界检测与位置限制
  - **✅ 模块化重构**: 使用 `GameHUD` 和 `GameMenus` 独立模块（1732行→1212行，减少30%）
  - **✅ 交互系统**: E键交互优先级（传送门 > 道具拾取 > 宝箱开启）
  - **✅ 中文本地化支持**: UTF-8编码处理🔄 - *OOP 重点考察区域*

这里是游戏对象的核心，利用**继承**和**多态**。

- **Base/** ✅
  - **✅ GameEntity.h/cpp**: 所有游戏对象的基类（继承 cocos2d::Sprite 或 Node），包含 HP、位置、碰撞体积。
  - **✅ Character.h/cpp**: 继承自 GameEntity，增加移动、状态机、攻击冷却、法力值等属性。
  
- **Player/** ✅
  - **✅ Player.h/cpp**: 玩家控制逻辑（输入处理、移动、碰撞半径16px）。
  - **✅ Mage.h/cpp**: 法师职业实现。
  - **🔄 Nymph**: 妮芙 - 远程攻击，粉色子弹，被动毒伤叠加，主动攻击+300%。
  - **🔄 Wisdael**: 维什戴尔 - 远程AOE，10%眩晕，20%闪避，范围爆炸。
  - **🔄 Mudrock**: 泥岩 - 近战范围，攻击5次获得护盾，最多9层。
  
- **Enemy/** ✅
  - **✅ Enemy.h/cpp**: 敌人基类，包含AI系统、毒伤系统、隐身系统、红标系统。
  - **✅ Ayao.h/cpp**: 阿咬 - 基础近战小怪，巡逻+追击。
  - **✅ KongKaZi.h/cpp**: 恐卡兹 - 红标敌人死亡后生成的定时炸弹。
  - **✅ Cup.h/cpp**: 魂灵圣杯 - 飞行辅助怪，分摊周围敌人90%伤害。
  - **✅ DeYi.h/cpp**: 得意 - 接近后爆炸的自爆怪。
  - **✅ Du.h/cpp**: 妒 - 远程精英怪，发射高伤子弹。
  - **✅ TangHuang.h/cpp**: 堂皇 - 精英怪，给周围怪物隐身/回血，死后生成铁灯盘。
  - **✅ IronLightCup.h/cpp**: 铁灯盘 - 需35次伤害击杀，阻挡子弹。
  - **✅ XinXing.h/cpp**: 新硎 - 近战精英怪，高伤害，死后生成3个铁矛头。
  - **✅ IronLance.h/cpp**: 铁矛头 - 需45次伤害击杀，阻挡子弹。
  - **✅ NiLuFire.h/cpp**: 尼卢火 - Boss召唤物，配合Boss技能造成伤害。
  - **🔄 KuiLongBoss.h/cpp**: 奎隆Boss - 三阶段Boss战
    - 阶段A(入定): 无敌，召唤尼卢火，【清火执】十字伤害
    - 阶段B(自在): 可移动，【惩五戒】5连击，【承三身】召唤托生莲座
    - 阶段C(无忧觉): 伤害翻倍，切换地图，玩家生命取决于阶段B损失的上限

- **Objects/** ✅
  - **✅ Item.h/cpp**: 道具定义系统，包含15种道具配置
    - 低阶道具6种（锈蚀刀片、急救药箱、坚守盾牌、投币玩具、活玫瑰、快乐水）
    - 高阶道具5种（复仇者、未知仪器、古老的铠甲、迷梦香精、金酒之杯）
    - 国王道具4种（国王的新枪、诸王的冠冕、国王的铠甲、国王的延伸）
    - 稀有度权重系统：低阶60%、高阶30%、国王10%
  - **✅ ItemDrop.h/cpp**: 地上可拾取道具系统
    - 道具掉落生成和浮动动画
    - 玩家距离检测和拾取交互
    - 15种道具效果应用（攻击、生命、减伤、冷却、治疗、MP等）
  - **✅ Chest.h/cpp**: 宝箱系统（已重构独立）
    - 随机道具生成和掉落
    - 与Room系统解耦
    - 支持堆叠限制检查

#### 4. Map (地图层) ✅ - *Roguelike 核心算法*

存放地图生成和管理的逻辑。

- **✅ MapGenerator.h/cpp**: 核心算法类，负责生成房间坐标、连接路径。
  - **BFS 地图生成算法**：从起始房开始，广度优先生成最多6个房间
  - 5×5网格矩阵管理房间位置
  - 自动生成房间间的走廊连接
  - 房间类型分配（BEGIN→NORMAL→END）

- **✅ Room.h/cpp**: 房间管理系统，包含：
  - **地形生成**: 地板、墙壁、门口的自动生成
  - **敌人生成点管理**: 支持多种敌人类型和数量配置
  - **✅ 宝箱管理**: 房间中心生成宝箱，支持开启交互
  - **✅ 道具掉落管理**: ItemDrop对象生成、位置设置、拾取检测
  - **✅ 传送门系统**: 终点房间传送门生成和交互检测
  - **碰撞检测**: 玩家与房间边界、门口的精确检测
  - 房间类型与尺寸调整（Boss房更大、道具房更小）
  
- **✅ Hallway.h/cpp**: 走廊类，连接相邻房间。
  - 水平走廊：4×4瓦片（128×128px）
  - 垂直走廊：4×12瓦片（128×384px）
  - 自动生成走廊墙壁（上下或左右）
  - 方向感知的边界检测（水平限制Y轴，垂直限制X轴）
  
- **✅ MiniMap.h/cpp**: 小地图显示。
  - 右上角显示房间布局
  - 实时追踪玩家位置（蓝色方块）
  - 显示已访问/未访问房间状态

#### 5. UI (界面层) ✅

存放纯 UI 逻辑，与游戏实体逻辑解耦。

- **✅ GameHUD.h/cpp**: 游戏HUD管理系统
  - 血条、蓝条显示与更新
  - 技能图标和冷却进度显示
  - 道具栏管理（血条蓝条下方，32px图标，每行5个）
  - 交互提示系统（动态显示"[E]获取{道具名}：{效果描述}"）
  - Debug信息显示
  - 操作说明面板
  
- **✅ GameMenus.h/cpp**: 游戏菜单管理系统
  - 暂停菜单（继续游戏、设置、返回主菜单、退出）
  - 游戏结束界面（R键重新开始、Q键返回主菜单）
  - 胜利界面（通关成功提示）
  - 半透明遮罩层管理
  - 键盘监听和回调处理
  
- **⚪ SettingsLayer.h/cpp**: 设置界面（音量调节、画面设置等）
- **⚪ MiniMap.h/cpp**: 小地图显示
- **⚪ FloatingText.h/cpp**: 飘血效果
- **⚪ VirtualJoystick.h/cpp**: (如果做手游操作) 虚拟摇杆

#### 6. Managers (管理器层) ⚪

存放**单例模式 (Singleton)** 类，用于跨场景管理数据。

- **⚪ GameManager.h/cpp**: 管理全局状态（当前分数、当前关卡层数、玩家选择的角色）。
- **⚪ SoundManager.h/cpp**: 封装 CocosDenshion 或 AudioEngine，统一管理背景音乐和音效播放。
- **⚪ CollisionManager.h/cpp**: (可选) 如果不用物理引擎，可在此处统一处理碰撞检测。

**注**: 目前碰撞检测在GameScene中实现

#### 7. Utils (工具层) ⚪

存放通用的静态函数或工具类。

- **⚪ MathUtils.h/cpp**: 额外的数学计算（如计算两个节点间的角度、向量运算）。
- **⚪ AnimUtils.h/cpp**: 快捷创建序列帧动画（Animation）的辅助函数。
- **⚪ CSVReader.h/cpp**: (可选) 如果怪物数值存在 CSV 表里，用这个读取。

---

## 技术实现细节

### 地图系统算法

**BFS 房间生成：**
```cpp
1. 从中心点(2,2)开始作为起始房
2. 使用队列进行广度优先搜索
3. 每次随机选择1-2个方向扩展
4. 最多生成6个房间
5. 避免房间重叠和超出5×5边界
```

**碰撞检测方案：**
- 边界框 (AABB) 检测，无物理引擎
- 考虑玩家碰撞半径 (16px = 0.5 tile)
- 边界向内缩进 48px (1.5 tiles) = 墙壁32px + 玩家半径16px
- 门口区域特殊处理：判断玩家Y/X坐标是否在门宽度范围内

**偶数瓦片对齐：**
```cpp
// 对于26个瓦片（偶数），中心在两个瓦片之间
startX = centerX - tileSize * (width/2 - 0.5)  // 第0列中心
      = centerX - 32 * 12.5 = centerX - 400
```

### 下一步开发重点

1. **MainMenuScene完善**
   - 开始游戏、角色选择、设置、退出功能
   - 与GameScene的场景切换集成
   
2. **SettingsLayer功能扩展**
   - 音量调节、画面设置选项
   - 键位配置和游戏选项
   - 与GameMenus的集成

3. **玩家角色完善**
   - Nymph（妮芙）：毒伤叠加系统、技能实现
   - Wisdael（维什戴尔）：范围爆炸子弹、眩晕/闪避被动
   - Mudrock（泥岩）：近战护盾机制

2. **Boss系统完善** (KuiLongBoss)
   - 阶段C（无忧觉）完整实现
   - 托生莲座（Boat）召唤逻辑
   - 地图切换机制

3. **UI/场景系统**
   - MainMenuScene（开始菜单）
   - 暂停菜单
   - 死亡结算界面

4. **音效系统**
   - SoundManager 单例
   - 背景音乐、战斗音效

---

## 最新开发进度 (2025-12-27)

### 已完成功能 ✅

**GameScene模块化重构完成:**
- **代码行数优化**: 1732行 → 1212行（减少30%，约520行）
- **GameHUD.h/cpp**: 独立HUD管理系统
  - 血条、蓝条显示与更新
  - 技能图标和冷却进度显示
  - 道具栏管理（血条蓝条下方，32px图标，每行5个）
  - 交互提示系统（动态显示"[E]获取{道具名}：{效果描述}"）
  - Debug信息和操作说明面板
- **GameMenus.h/cpp**: 独立菜单管理系统
  - 暂停菜单（继续游戏、设置、返回主菜单、退出）
  - 游戏结束界面（R键重新开始、Q键返回主菜单）
  - 胜利界面（通关成功提示）
  - 半透明遮罩层和键盘监听管理
- **回调解耦设计**: 使用 `std::function` 实现菜单与场景的松耦合
- **CMake配置**: 已添加新模块到构建系统

**道具系统完整实现:****
- **Item.h/cpp**: 15种道具配置（低阶6种60%，高阶5种30%，国王4种10%）
- **ItemDrop.h/cpp**: 地上道具掉落、拾取交互、效果应用系统
- **Chest.h/cpp**: 宝箱系统重构，支持随机道具生成和掉落

**敌人系统完整实现:** (11种敌人 + 1个Boss)
| 类型 | 敌人 | 特点 |
|------|------|------|
| 小怪 | Ayao(阿咬) | 近战，巡逻+追击 |
| 小怪 | KongKaZi(恐卡兹) | 红标敌人死亡生成，定时炸弹 |
| 小怪 | DeYi(得意) | 接近后自爆 |
| 精英 | Cup(魂灵圣杯) | 飞行，分摊90%伤害 |
| 精英 | Du(妒) | 远程高伤子弹 |
| 精英 | TangHuang(堂皇) | 隐身/回血光环，死后生成铁灯盘 |
| 精英 | XinXing(新硎) | 近战高伤，死后生成3个铁矛头 |
| 衍生 | IronLightCup(铁灯盘) | 35次伤害击杀，阻挡子弹 |
| 衍生 | IronLance(铁矛头) | 45次伤害击杀，阻挡子弹 |
| Boss召唤 | NiLuFire(尼卢火) | 配合Boss【清火执】技能 |
| Boss召唤 | Boat(托生莲座) | 碰撞扣生命上限，无敌2秒 |
| **Boss** | KuiLongBoss(奎隆) | 三阶段：入定→自在→无忧觉 |

**Enemy基类高级特性:**
- **毒伤系统**: `applyNymphPoison()` 支持Nymph的毒层叠加
- **隐身系统**: `Stealth` 多来源管理，支持TangHuang的隐身光环
- **红标系统**: `tryApplyRedMark()` 概率标记，死后生成KongKaZi
- **伤害分担**: Cup的 `absorbDamage()` 机制

**交互系统:**
- E键交互优先级：传送门 > 道具拾取 > 宝箱开启
- 动态交互提示："[E]获取{道具名}：{效果描述}"格式
- 中文本地化：UTF-8编码支持，u8前缀处理

**UI系统:**
- 道具栏显示：血条蓝条下方显示已获得道具图标
- 32px图标大小，每行最多5个，自动换行
- 图层一致性：与血条蓝条相同ZOrder层级

**Room系统扩展:**
- 宝箱生成和开启管理
- ItemDrop对象生成、定位、拾取检测
- 传送门系统集成
- **✅ TerrainLayouts.h/cpp**: 地形生成系统拆分（~300行代码独立）

**地图系统模块化:**
- **✅ 地形系统重构**: 从Room.cpp中提取TerrainLayouts独立模块
- **✅ 10种地形布局**: layoutFiveBoxes、layoutNineBoxes等地形生成算法
- **✅ 代码复用**: TerrainLayoutHelper静态类，Room通过委托调用

## 重构成果总览

| 文件 | 重构前 | 重构后 | 减少行数 | 说明 |
|------|--------|--------|----------|------|
| **GameScene.cpp** | 1732行 | 1212行 | **-520行 (30%)** | 拆分HUD和菜单系统 |
| **Room.cpp** | 1039行 | ~740行 | **-300行 (29%)** | 拆分地形生成系统 |
| **新增模块** | - | 4个文件 | **+630行** | GameHUD、GameMenus、TerrainLayouts |

**重构效果:**
- **单文件复杂度降低**: 最大文件从1732行降到1212行
- **职责分离清晰**: HUD显示、菜单交互、地形生成各司其职
- **可维护性提升**: 模块独立，便于调试和扩展
- **代码复用增强**: 地形布局算法可被其他系统调用

### 技术成果

1. **代码质量提升**: GameScene模块化重构，单文件行数从1732减至1212
2. **架构优化**: HUD和菜单系统独立，符合单一职责原则
3. **维护性改善**: 回调机制实现组件解耦，提高代码可维护性
4. **编码规范**: 中文字符串统一使用u8前缀，UTF-8编码支持
5. **构建系统**: CMakeLists.txt同步更新，支持新模块编译

### 架构特点

- **模块化设计**: GameScene重构，HUD和菜单系统独立（减少30%代码行数）
- **松耦合架构**: 使用回调机制实现菜单与场景解耦
- **单一职责原则**: GameHUD专注显示，GameMenus专注交互，GameScene专注游戏逻辑
- **可维护性提升**: 降低单文件复杂度，提高代码可读性和可维护性
- **数据驱动**: 道具配置、稀有度权重可配置
- **事件驱动**: 交互检测、UI更新响应式设计
- **完整继承体系**: `GameEntity → Character → Enemy/Player → 具体实现`
- **多态应用**: 虚函数 `attack()`, `die()`, `executeAI()`, `isPoisonable()` 等

---

## 资源文件结构

```
Resources/
├── Enemy/                    # 敌人动画资源
│   ├── AYao/                 # 阿咬 (Attack/Die/Move)
│   ├── Cup/                  # 魂灵圣杯 (Die/Idle)
│   ├── KongKaZi/             # 恐卡兹 (Attack/Die/Move)
│   ├── DeYi/                 # 得意 (Die/Move)
│   ├── Du/                   # 妒 (Attack/Bullet/Die/Move)
│   ├── TangHuang&&Iron LightCup/  # 堂皇+铁灯盘
│   ├── XinXing&&Iron Lance/  # 新硎+铁矛头
│   ├── NiLu Fire/            # 尼卢火 (Attack/Burning)
│   ├── Boat/                 # 托生莲座 (Die/Idle/Move)
│   └── _BOSS_kuiLong/        # 奎隆Boss (多阶段动画)
├── Player/                   # 玩家角色动画
│   ├── Nymph/                # 妮芙 (Attack/Bullet/Die/Idle/Move/Skill_*)
│   ├── Wisdael/              # 维什戴尔 (Attack/Bullet/Die/Idle/Move/Skill_*)
│   └── Mudrock/              # 泥岩 (Attack/Die/Idle/Move/Skill_*)
├── Map/                      # 地图素材
│   ├── Floor/Wall/Door/      # 基础地形
│   ├── Barrier/              # 障碍物（木箱等）
│   ├── Chest/                # 宝箱
│   ├── Portal/               # 传送门
│   └── Fire Generator/       # 火焰地块
├── Property/                 # 道具图标
│   ├── LowLevel/             # 低阶藏品 (6种)
│   └── HighLevel/            # 高阶藏品 (5种) + 国王藏品 (4种)
└── UIs/                      # UI素材
    ├── Skills/               # 技能图标
    └── StatusBars/           # 血条蓝条素材
```

---

## C++ 特性使用统计

| 特性 | 使用位置 | 说明 |
|------|----------|------|
| **STL容器** | `std::vector`, `std::map`, `std::set` | 敌人列表、道具配置、隐身来源管理 |
| **迭代器** | Enemy遍历、道具列表 | 范围for循环、标准迭代器 |
| **类与多态** | Entity继承体系 | `GameEntity→Character→Enemy/Player` |
| **模板** | Cocos2d-x CREATE_FUNC | 工厂模式宏 |
| **异常处理** | 资源加载 | try-catch保护 |
| **函数重载** | `takeDamage()` | 多版本伤害处理 |
| **C++11+** | `override`, `nullptr`, lambda, auto | 现代C++特性 |